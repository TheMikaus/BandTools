# MP3 Implementation Architecture Diagram

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        PolyRhythmMetronome Android                        â”‚
â”‚                       MP3 Tick Sound Architecture                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              App Startup                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                           â”‚
â”‚  1. App Launches                                                          â”‚
â”‚       â†“                                                                   â”‚
â”‚  2. SimpleMetronomeEngine.__init__()                                      â”‚
â”‚       â†“                                                                   â”‚
â”‚  3. Mp3TickCache.__init__()                                              â”‚
â”‚       â†“                                                                   â”‚
â”‚  4. _scan_ticks_folder()  â”€â”€â†’  Reads ticks/ directory                   â”‚
â”‚       â†“                         Identifies single/paired MP3s            â”‚
â”‚  5. Tick names available        Populates _pairs dictionary              â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           User Adds Layer                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                           â”‚
â”‚  1. User taps + button                                                    â”‚
â”‚       â†“                                                                   â”‚
â”‚  2. LayerWidget created                                                   â”‚
â”‚       â†“                                                                   â”‚
â”‚  3. Mode spinner shows: ["tone", "drum", "mp3_tick"]                     â”‚
â”‚       â†“                                                                   â”‚
â”‚  4. User selects "mp3_tick"                                              â”‚
â”‚       â†“                                                                   â”‚
â”‚  5. _build_mode_value() called                                           â”‚
â”‚       â†“                                                                   â”‚
â”‚  6. get_mp3_tick_choices() â”€â”€â†’ Mp3TickCache.get_available_ticks()       â”‚
â”‚       â†“                                                                   â”‚
â”‚  7. Tick dropdown populated with available ticks                         â”‚
â”‚       â†“                                                                   â”‚
â”‚  8. User selects tick (e.g., "woodblock")                                â”‚
â”‚       â†“                                                                   â”‚
â”‚  9. layer["mp3_tick"] = "woodblock"                                      â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Metronome Playback                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                           â”‚
â”‚  SimpleMetronomeEngine._run() [metronome thread]                         â”‚
â”‚       â†“                                                                   â”‚
â”‚  For each layer on beat:                                                  â”‚
â”‚       â†“                                                                   â”‚
â”‚  1. Determine if accent beat (first of measure)                          â”‚
â”‚       â†“                                                                   â”‚
â”‚  2. _get_audio_data(layer, is_accent=True/False)                         â”‚
â”‚       â”‚                                                                   â”‚
â”‚       â”œâ”€â”€â†’ if mode == "mp3_tick":                                        â”‚
â”‚       â”‚      â†“                                                            â”‚
â”‚       â”‚    mp3_ticks.get(layer["mp3_tick"], is_accent)                   â”‚
â”‚       â”‚      â†“                                                            â”‚
â”‚       â”‚    Mp3TickCache.get("woodblock", is_accent=True)                 â”‚
â”‚       â”‚      â”‚                                                            â”‚
â”‚       â”‚      â”œâ”€â”€â†’ Look up in _pairs: ("woodblock_1.mp3", "woodblock_2.mp3") â”‚
â”‚       â”‚      â”‚                                                            â”‚
â”‚       â”‚      â”œâ”€â”€â†’ If is_accent: path = "woodblock_1.mp3"                 â”‚
â”‚       â”‚      â”‚    Else:          path = "woodblock_2.mp3"                â”‚
â”‚       â”‚      â”‚                                                            â”‚
â”‚       â”‚      â””â”€â”€â†’ _wave_cache.get(path)                                  â”‚
â”‚       â”‚             â†“                                                     â”‚
â”‚       â”‚           WaveCache.get(path)                                    â”‚
â”‚       â”‚             â”‚                                                     â”‚
â”‚       â”‚             â”œâ”€â”€â†’ Check cache: if cached, return                  â”‚
â”‚       â”‚             â”‚                                                     â”‚
â”‚       â”‚             â””â”€â”€â†’ Not cached:                                     â”‚
â”‚       â”‚                    â†“                                              â”‚
â”‚       â”‚                  _read_mp3(path)  [see below]                    â”‚
â”‚       â”‚                    â†“                                              â”‚
â”‚       â”‚                  Cache and return samples                        â”‚
â”‚       â”‚                                                                   â”‚
â”‚       â””â”€â”€â†’ Return numpy array of float32 samples                         â”‚
â”‚                                                                           â”‚
â”‚  3. Apply volume: audio_data * volume                                    â”‚
â”‚       â†“                                                                   â”‚
â”‚  4. _play_sound(audio_data, volume, channel)                             â”‚
â”‚       â†“                                                                   â”‚
â”‚  5. Convert to stereo, int16                                             â”‚
â”‚       â†“                                                                   â”‚
â”‚  6. AudioTrack.write() â”€â”€â†’ Audio plays                                   â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MP3 Decoding Process (First Load)                      â”‚
â”‚                         WaveCache._read_mp3()                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                           â”‚
â”‚  Input: MP3 file path                                                     â”‚
â”‚       â†“                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚                  Android MediaExtractor                       â”‚        â”‚
â”‚  â”‚  - Load MP3 file                                             â”‚        â”‚
â”‚  â”‚  - Find audio track                                          â”‚        â”‚
â”‚  â”‚  - Extract format info (sample rate, channels, codec)       â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚       â†“                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚                  Android MediaCodec                           â”‚        â”‚
â”‚  â”‚  - Create decoder for MP3 codec                              â”‚        â”‚
â”‚  â”‚  - Configure with audio format                               â”‚        â”‚
â”‚  â”‚  - Start decoder                                             â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚       â†“                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚                    Decode Loop                                â”‚        â”‚
â”‚  â”‚                                                               â”‚        â”‚
â”‚  â”‚  While not EOF:                                              â”‚        â”‚
â”‚  â”‚    1. Dequeue input buffer                                   â”‚        â”‚
â”‚  â”‚    2. Read compressed data from extractor                    â”‚        â”‚
â”‚  â”‚    3. Queue input buffer                                     â”‚        â”‚
â”‚  â”‚    4. Dequeue output buffer                                  â”‚        â”‚
â”‚  â”‚    5. Read PCM samples                                       â”‚        â”‚
â”‚  â”‚    6. Append to samples list                                 â”‚        â”‚
â”‚  â”‚    7. Release output buffer                                  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚       â†“                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚               Post-Processing                                 â”‚        â”‚
â”‚  â”‚  - Concatenate all decoded samples                           â”‚        â”‚
â”‚  â”‚  - Convert stereo to mono (if needed)                        â”‚        â”‚
â”‚  â”‚  - Normalize to float32 [-1.0, 1.0]                          â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚       â†“                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚               Resampling (if needed)                          â”‚        â”‚
â”‚  â”‚  - If sample_rate != 44100:                                  â”‚        â”‚
â”‚  â”‚    - Linear interpolation                                    â”‚        â”‚
â”‚  â”‚    - Resample to 44100 Hz                                    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚       â†“                                                                   â”‚
â”‚  Output: NumPy array[float32] of audio samples                           â”‚
â”‚       â†“                                                                   â”‚
â”‚  Cached in WaveCache._c dictionary                                       â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ticks/     â”‚
â”‚   folder     â”‚
â”‚              â”‚
â”‚ â€¢ click.mp3  â”‚
â”‚ â€¢ wood_1.mp3 â”‚
â”‚ â€¢ wood_2.mp3 â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ App Startup
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Mp3TickCache      â”‚
â”‚                     â”‚
â”‚ _scan_ticks_folder()â”‚
â”‚         â†“           â”‚
â”‚   _pairs = {        â”‚
â”‚     "click": ("click.mp3", None),
â”‚     "wood":  ("wood_1.mp3", "wood_2.mp3")
â”‚   }                 â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ get_available_ticks()
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   UI Dropdown       â”‚
â”‚                     â”‚
â”‚ â€¢ click             â”‚
â”‚ â€¢ wood              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ User selects "wood"
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Layer Data        â”‚
â”‚                     â”‚
â”‚ {                   â”‚
â”‚   "mode": "mp3_tick"â”‚
â”‚   "mp3_tick": "wood"â”‚
â”‚   ...               â”‚
â”‚ }                   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ On beat (is_accent=True)
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Mp3TickCache.get()  â”‚
â”‚   ("wood", True)    â”‚
â”‚         â†“           â”‚
â”‚   Select wood_1.mp3 â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WaveCache.get()    â”‚
â”‚  ("wood_1.mp3")     â”‚
â”‚         â†“           â”‚
â”‚   Check cache?      â”‚
â”‚    â”œâ”€Yes â†’ Return   â”‚
â”‚    â””â”€No  â†’ Decode   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ If not cached
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MediaExtractor              â”‚
â”‚  + MediaCodec                â”‚
â”‚                              â”‚
â”‚  MP3 â†’ PCM (int16)          â”‚
â”‚      â†’ NumPy (float32)      â”‚
â”‚      â†’ Cache + Return       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Audio samples      â”‚
â”‚  [0.1, 0.3, -0.2...]â”‚
â”‚  (float32 array)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Apply volume
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  _play_sound()      â”‚
â”‚                     â”‚
â”‚  â€¢ Convert to stereoâ”‚
â”‚  â€¢ Convert to int16 â”‚
â”‚  â€¢ AudioTrack.write â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
   ğŸ”Š Sound!
```

## Class Relationships

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SimpleMetronomeEngine                     â”‚
â”‚                                                        â”‚
â”‚  Fields:                                              â”‚
â”‚    â€¢ tone_gen: ToneGenerator                          â”‚
â”‚    â€¢ drum_synth: DrumSynth                            â”‚
â”‚    â€¢ mp3_ticks: Mp3TickCache â—„â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚                                        â”‚              â”‚
â”‚  Methods:                              â”‚              â”‚
â”‚    â€¢ _get_audio_data(layer, is_accent)â”‚              â”‚
â”‚         â†“                              â”‚              â”‚
â”‚         Calls mp3_ticks.get()          â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â”‚ has-a
                                         â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚        Mp3TickCache                    â”‚
                    â”‚                                        â”‚
                    â”‚  Fields:                              â”‚
                    â”‚    â€¢ _wave_cache: WaveCache â—„â”€â”€â”€â”€â”€â”   â”‚
                    â”‚    â€¢ _pairs: dict                  â”‚   â”‚
                    â”‚                                    â”‚   â”‚
                    â”‚  Methods:                          â”‚   â”‚
                    â”‚    â€¢ _scan_ticks_folder()          â”‚   â”‚
                    â”‚    â€¢ get_available_ticks()         â”‚   â”‚
                    â”‚    â€¢ get(name, is_accent)          â”‚   â”‚
                    â”‚         â†“                          â”‚   â”‚
                    â”‚         Calls _wave_cache.get()    â”‚   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”˜
                                                         â”‚
                                                         â”‚ has-a
                                                         â”‚
                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                      â”‚       WaveCache                  â”‚
                                      â”‚                                  â”‚
                                      â”‚  Fields:                        â”‚
                                      â”‚    â€¢ _c: dict (cache)           â”‚
                                      â”‚                                  â”‚
                                      â”‚  Methods:                        â”‚
                                      â”‚    â€¢ get(path)                  â”‚
                                      â”‚    â€¢ _read_mp3(path)            â”‚
                                      â”‚    â€¢ _read_wav_any(path)        â”‚
                                      â”‚    â€¢ _resample_linear()         â”‚
                                      â”‚         â†“                        â”‚
                                      â”‚         Uses MediaExtractor      â”‚
                                      â”‚              + MediaCodec        â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## State Machine - Layer Mode

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer      â”‚
â”‚  Created    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     mode = "tone"
â”‚             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Mode      â”‚     mode = "drum"      â”‚
â”‚  Selection  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚             â”‚     mode = "mp3_tick"  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                        â”‚
              â”‚                        â”‚
              â”‚                        â†“
              â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚              â”‚  MP3 Tick Mode   â”‚
              â”‚              â”‚                  â”‚
              â”‚              â”‚  â€¢ Tick dropdown â”‚
              â”‚              â”‚  â€¢ Select tick   â”‚
              â”‚              â”‚  â€¢ Play          â”‚
              â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                        â”‚
              â”‚                        â†“
              â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚              â”‚  On Beat         â”‚
              â”‚              â”‚                  â”‚
              â”‚              â”‚  is_accent?      â”‚
              â”‚              â”‚    â”œâ”€Yes: _1 fileâ”‚
              â”‚              â”‚    â””â”€No:  _2 fileâ”‚
              â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â†“
       [Other modes...]
```

## Threading Model

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Main UI Thread                       â”‚
â”‚  â€¢ Kivy event loop                                       â”‚
â”‚  â€¢ User interactions                                     â”‚
â”‚  â€¢ LayerWidget updates                                   â”‚
â”‚  â€¢ Dropdown population                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ Start metronome
                         â”‚
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             SimpleMetronomeEngine._run()                 â”‚
â”‚                  (Separate Thread)                       â”‚
â”‚                                                          â”‚
â”‚  â€¢ Beat timing loop                                     â”‚
â”‚  â€¢ Calls _get_audio_data() â”€â”€â†’ Mp3TickCache            â”‚
â”‚  â€¢ Calls _play_sound()      â”€â”€â†’ AudioTrack.write()     â”‚
â”‚  â€¢ No file I/O (all cached)                             â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ Schedule callback
                         â”‚
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Clock.schedule_once()                       â”‚
â”‚              (Back to UI Thread)                         â”‚
â”‚                                                          â”‚
â”‚  â€¢ Visual feedback (color flash)                        â”‚
â”‚  â€¢ UI updates                                            â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## File Scanning Logic

```
Startup: Mp3TickCache.__init__() â†’ _scan_ticks_folder()

For each .mp3 file in ticks/:
    
    Extract name without extension
    
    If name ends with "_1":
        base_name = name[:-2]
        
        Look for matching "_2" file:
            If found:
                _pairs[base_name] = (path_1, path_2)  # Paired
            Else:
                _pairs[name] = (path, None)            # Single (keeps _1)
    
    Else if name ends with "_2":
        (Only process if no matching _1 was found)
    
    Else:
        _pairs[name] = (path, None)                    # Single

Examples:
    click.mp3                    â†’ _pairs["click"] = (click.mp3, None)
    wood_1.mp3 + wood_2.mp3     â†’ _pairs["wood"] = (wood_1.mp3, wood_2.mp3)
    test_1.mp3 (no matching _2) â†’ _pairs["test_1"] = (test_1.mp3, None)
```

## Performance Characteristics

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Operation      â”‚   When         â”‚   Performance   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Scan ticks/      â”‚ App startup    â”‚ O(n) files      â”‚
â”‚ Decode MP3       â”‚ First use      â”‚ ~10-50ms/file   â”‚
â”‚ Cache lookup     â”‚ Every beat     â”‚ O(1)            â”‚
â”‚ Array access     â”‚ Every beat     â”‚ O(1)            â”‚
â”‚ Volume adjust    â”‚ Every beat     â”‚ O(m) samples    â”‚
â”‚ Stereo convert   â”‚ Every beat     â”‚ O(m) samples    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Memory per tick sound (example):
    100ms @ 44.1kHz mono = 4,410 samples
    float32 = 4 bytes/sample
    Memory = 4,410 Ã— 4 = 17,640 bytes (~17 KB)
```

## Error Handling Flow

```
User selects MP3 tick
        â†“
_get_audio_data(layer, is_accent)
        â†“
    try:
        mp3_ticks.get(tick_name, is_accent)
            â†“
        WaveCache.get(path)
            â†“
        _read_mp3(path)
            â†“
        [MediaCodec decode]
            â†“
        Return samples
    catch Exception:
        Log error â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        Return None                 â”‚
        â†“                           â†“
    If None:                  User sees in logs
        Fallback to tone      (doesn't crash)
        Return beep
```

This architecture ensures robust operation even when MP3 files are missing or corrupted.
