# Version 1.2.0 Technical Changes

## Overview

Version 1.2.0 addresses several user-reported bugs and implements UI improvements to enhance the user experience. The main changes focus on audio playback reliability, visual feedback improvements, and layout optimization.

## Bug Fixes

### 1. Audio Playback Reliability

**Issue**: Play button did not consistently play audio.

**Root Cause**: The `simpleaudio` library was not being auto-installed correctly. The engine used a try/catch import but did not leverage the existing `ensure_pkg()` auto-install function.

**Fix**: Modified `SimpleMetronomeEngine.__init__()` to use `ensure_pkg("simpleaudio")` for proper auto-installation.

**Code Changes**:
```python
# Before (line ~315-318)
try:
    import simpleaudio as sa
    self.audio_lib = 'simpleaudio'
    self.sa = sa
except ImportError:
    # fallback...

# After
try:
    sa = ensure_pkg("simpleaudio")
    self.audio_lib = 'simpleaudio'
    self.sa = sa
    print(f"[audio] Using simpleaudio for playback")
except ImportError as e:
    # fallback with debug info...
```

**Impact**: Users should now consistently hear audio when pressing PLAY, even on fresh installations.

---

### 2. Per-Layer Visual Flashing

**Issue**: The entire screen flashed on each beat, making it difficult to identify which layer was playing. This was inconsistent with the desktop version which flashes individual layer rows.

**Root Cause**: The `on_beat()` callback in `MetronomeWidget` was changing a full-screen overlay color instead of targeting individual layer widgets.

**Fix**: 
1. Added `flash()` method to `LayerWidget` class
2. Added `uid_to_widget` tracking dictionary to `LayerListWidget`
3. Added `flash_uid()` method to `LayerListWidget` to trigger specific layer flashes
4. Modified `on_beat()` callback to call layer-specific flash methods
5. Removed full-screen flash overlay

**Code Changes**:

**LayerWidget** (new methods):
```python
def flash(self, color=None, duration=0.12):
    """Flash the layer widget with the specified color"""
    if color is None:
        color = self.layer.get("color", "#9CA3AF")
    
    # Parse hex color and apply
    try:
        r = int(color[1:3], 16) / 255.0
        g = int(color[3:5], 16) / 255.0
        b = int(color[5:7], 16) / 255.0
        
        # Set flash color with full opacity
        self.bg_color.rgba = (r, g, b, 0.8)
        
        # Schedule flash to clear after duration
        if self.flash_scheduled:
            self.flash_scheduled.cancel()
        self.flash_scheduled = Clock.schedule_once(lambda dt: self._clear_flash(), duration)
    except (ValueError, IndexError):
        pass

def _clear_flash(self):
    """Restore the base background color"""
    self.bg_color.rgba = self.base_rgba
```

**LayerListWidget** (new method):
```python
def flash_uid(self, uid, color):
    """Flash the layer widget with the specified UID"""
    widget = self.uid_to_widget.get(uid)
    if widget:
        widget.flash(color)
```

**MetronomeWidget.on_beat()** (simplified):
```python
# Before
def on_beat(self, side, uid, color):
    # Parse color and flash full screen...
    self.flash_color.rgba = (r, g, b, 0.3)
    # ...

# After
def on_beat(self, side, uid, color):
    """Called when a beat occurs - flash the specific layer row"""
    if side == 'left':
        self.left_list.flash_uid(uid, color)
    else:
        self.right_list.flash_uid(uid, color)
```

**Impact**: Visual feedback is now more precise and matches desktop behavior. Users can easily see which layer is playing at any given moment.

---

## UI Improvements

### 3. BPM Button Layout Optimization

**Issue**: BPM preset buttons were arranged in a 4-column grid (2 rows), taking up more vertical space and not utilizing horizontal space efficiently.

**Fix**: Changed layout to 8 columns (1 row), making buttons taller but thinner to fit all 8 presets in a single horizontal row.

**Code Changes**:
```python
# Before
preset_grid = GridLayout(cols=4, size_hint_y=0.4, spacing='5dp')

# After
preset_grid = GridLayout(cols=8, size_hint_y=0.45, spacing='2dp', height='50dp')
```

**Additional Changes**:
- Increased header height from `120dp` to `140dp` to accommodate taller buttons
- Adjusted size_hint_y proportions in header: title 0.3→0.25, BPM row unchanged at 0.3, buttons 0.4→0.45

**Impact**: All 8 BPM presets are now visible in one row, improving discoverability and reducing need for eye movement across rows.

---

### 4. Reduced UI Spacing

**Issue**: Large gaps between UI elements (particularly between BPM buttons and layer lists) wasted valuable screen space.

**Fix**: Reduced spacing in critical areas to create a more compact layout.

**Code Changes**:
```python
# MetronomeWidget._build_header()
header = BoxLayout(orientation='vertical', size_hint_y=None, height='140dp', spacing='2dp')
# Before: spacing='5dp'

# MetronomeWidget._build_ui()
layers_container = BoxLayout(orientation='vertical', spacing='2dp')
# Before: spacing='10dp'

# BPM preset grid
preset_grid = GridLayout(cols=8, size_hint_y=0.45, spacing='2dp', height='50dp')
# Before: spacing='5dp'
```

**Impact**: More screen space available for layer lists (the primary content), resulting in less scrolling needed.

---

## Code Structure Changes

### Removed Components

The following components were removed as they are no longer needed:

1. **Flash overlay in MetronomeWidget**:
   - `self.flash_overlay` - Full-screen overlay widget
   - `self.flash_color` - Color object for overlay
   - `self.flash_rect` - Rectangle for overlay
   - `self.flash_scheduled` - Flash clear scheduler
   - `_update_flash_rect()` - Method to update overlay position
   - `_clear_flash()` - Method to clear flash

2. **FloatLayout wrapper**: Removed FloatLayout that was only needed for overlay positioning

### New Components

1. **LayerWidget enhancements**:
   - `self.bg_color` - Color object reference for background (for flashing)
   - `self.base_rgba` - Base color RGBA tuple (for restoring after flash)
   - `self.flash_scheduled` - Flash clear scheduler (per-layer)
   - `flash()` - Method to flash the layer widget
   - `_clear_flash()` - Method to restore base color

2. **LayerListWidget enhancements**:
   - `self.uid_to_widget` - Dictionary mapping layer UIDs to widgets
   - `flash_uid()` - Method to flash a specific layer by UID
   - Updated `refresh()` to populate uid_to_widget mapping

---

## Testing Recommendations

### Critical Tests

1. **Audio Playback**: Verify Play button works on fresh installs and with various layer configurations
2. **Layer Flashing**: Verify individual layers flash with correct colors and timing
3. **BPM Buttons**: Verify all 8 buttons are visible and functional in one row

### Regression Tests

1. Verify layer management (add/delete/edit) still works
2. Verify save/load functionality is unaffected
3. Verify orientation changes don't break layout
4. Verify performance with many layers (5+ per ear)

### Edge Cases

1. Test with no layers (should not crash)
2. Test with invalid color codes (should handle gracefully)
3. Test with very fast tempos and subdivisions (should not lag)

See [Bug Fixes v1.2 Test Plan](../test_plans/bug_fixes_v1.2_test_plan.md) for comprehensive test cases.

---

## Performance Implications

### Positive Impacts

1. **Reduced Memory**: Removing full-screen flash overlay reduces widget tree complexity
2. **Better Performance**: Per-layer flashing is more efficient than full-screen redraws
3. **Cleaner Code**: Simpler event flow in on_beat() callback

### Potential Concerns

None identified. The per-layer flashing approach is actually more efficient than the previous full-screen overlay method.

---

## Migration Notes

### For Users

No migration needed. Changes are transparent to users. Existing saved rhythm patterns will load and work correctly.

### For Developers

If extending the flashing functionality:
- Use `LayerWidget.flash(color, duration)` to flash a layer
- Use `LayerListWidget.flash_uid(uid, color)` to flash by layer ID
- Flash duration default is 0.12 seconds (matches FLASH_DURATION constant)
- Colors should be in hex format: "#RRGGBB"

---

## Future Enhancements

Based on these changes, potential future improvements could include:

1. **Configurable Flash Duration**: Allow users to adjust flash duration in settings
2. **Flash Intensity**: Allow users to adjust flash opacity/intensity
3. **Flash Animations**: Add fade-in/fade-out animations for smoother visual effect
4. **Multiple Flash Styles**: Support different flash patterns (pulse, fade, blink, etc.)
5. **Accessibility Options**: High contrast mode, disable flashing option for photosensitive users

---

## References

- [CHANGELOG.md](../../CHANGELOG.md) - User-facing change log
- [Bug Fixes v1.2 Test Plan](../test_plans/bug_fixes_v1.2_test_plan.md) - Comprehensive test plan
- [main.py](../../main.py) - Main application file with all changes
- Desktop version: [Poly_Rhythm_Metronome.py](../../../Desktop/Poly_Rhythm_Metronome.py) - Reference for desktop flashing behavior
