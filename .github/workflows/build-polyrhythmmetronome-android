name: Build PolyRhythmMetronomeAPK (Manual)

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Buildozer command"
        type: bool
        required: false
        default: android debug

      create_release:
        description: 'Create a release after build'
        required: false
        default: android debug
        type: boolean

      spec_path:
        description: "Path to buildozer.spec (usually ./buildozer.spec)"
        type: string
        required: true
        default: ./PolyRhythmMetronome/android/buildozer.spec

      clean:
        description: "Clean before build?"
        type: boolean
        default: false


permissions:
  contents: write
  packages: write


concurrency:
  group: build-android-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Optional: cache Buildozer dirs for faster repeats
      - name: Cache global .buildozer
        uses: actions/cache@v4
        with:
          path: ~/.buildozer
          key: global-buildozer-${{ runner.os }}-${{ hashFiles(inputs.spec_path) }}
      - name: Cache project .buildozer
        uses: actions/cache@v4
        with:
          path: .buildozer
          key: proj-buildozer-${{ runner.os }}-${{ hashFiles(inputs.spec_path) }}

      - name: (Optional) Clean
        if: inputs.clean == 'true'
        run: |
          buildozer android clean || true
          rm -rf .buildozer bin || true

      - name: Build with Buildozer
        id: build
        uses: ArtemSBulgakov/buildozer-action@v1
        with:
          # Run the exact command chosen in the dispatch form
          command: ${{ inputs.target }}
          # If your buildozer.spec is not at repo root, set the working dir:
          workdir: .
          # Optionally pin a specific Buildozer version:
          # buildozer_version: stable
          # You can also pass env vars via 'env_*' inputs if the action supports them

      - name: Upload artifacts (APK/AAB)
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: |
            bin/*.apk
            bin/*.aab
          if-no-files-found: warn
